var citrusLiveSearch=function(e){var t=this;this.arParams={AJAX_PAGE:e.AJAX_PAGE,CONTAINER_ID:e.CONTAINER_ID,INPUT_ID:e.INPUT_ID,MIN_QUERY_LEN:parseInt(e.MIN_QUERY_LEN),DELAY:parseInt(e.DELAY)},this.$input=$("#"+this.arParams.INPUT_ID),this.$container=$("#"+this.arParams.CONTAINER_ID),this.$form=this.$container.find(".js-search"),this.$overlay=$(".js-search-overlay-hide"),this.$result_list=this.$container.find(".js-search-result-list"),this.CASH={},this.RESULT=[],this.loadingCount=0,this.timeoutId=!1,this.checkLength=function(){return this.$input.val().length>=this.arParams.MIN_QUERY_LEN},this.updateFormClass=function(e){var e=e||0,s=t.$input.val();this.loadingCount+=e,this.$form[this.loadingCount?"addClass":"removeClass"]("is-loading"),s.length>0?t.$form.addClass("is-cancel").removeClass("is-empty"):t.$form.addClass("is-empty").removeClass("is-cancel")},this.toggleDescriptionText=function(){t.checkLength()?(t.$form.find(".search-result-description").addClass("hidden"),t.$form.find(".js-search-result-no")[this.RESULT.length?"addClass":"removeClass"]("hidden")):(t.$form.find(".search-result-description").removeClass("hidden"),t.$form.find(".js-search-result-no").addClass("hidden"))},this.clearResult=function(){this.RESULT=[],this.updateResultView()},this.clear=function(){this.clearResult(),this.$input.val("")},this.updateResultView=function(){this.$result_list.html(""),t.toggleDescriptionText(),t.RESULT.forEach(function(e,s){var i=s?"":"_selected";htmlItem='<a href="'+e.URL+'" class="search-result-item '+i+' ">',e.PICTURE&&(htmlItem+='<div class="search-result-item-images"><span style="background-image: url(\''+e.PICTURE+"')\"></span></div>"),htmlItem+='<div class="search-result-item-body">',htmlItem+='<div class="search-result-item-name">'+e.NAME+"</div>",e.ADDRESS&&(htmlItem+='<div class="search-result-item-address">'+e.ADDRESS+"</div>"),e.COST&&(htmlItem+='<div class="search-result-item-price">'+e.COST+"</div>"),htmlItem+="</div>",htmlItem+="</a>",t.$result_list.append(htmlItem)})},this.updateResult=function(e){return e?(this.selectIndex=0,t.timeoutId&&clearTimeout(t.timeoutId),t.CASH[e]?(t.RESULT=t.CASH[e],void t.updateResultView()):void(t.timeoutId=setTimeout(function(){t.updateFormClass(1),$.ajax({url:t.arParams.AJAX_PAGE,type:"POST",dataType:"json",data:{ajax_call:"y",INPUT_ID:t.arParams.INPUT_ID,q:e,l:t.arParams.MIN_QUERY_LEN}}).done(function(e){var e=e||[];t.RESULT=e.ITEMS,t.CASH[e.QUERY]=e.ITEMS,t.updateResultView(),t.updateFormClass(-1)}).fail(function(){console.log("error")}).always(function(){})},t.arParams.DELAY))):void 0},this.selectIndex=0,this.selectResultItem=function(e,t){if("undefined"!=typeof e&&this.RESULT.length){var s=t?e:this.selectIndex+e;s=s>this.RESULT.length-1?this.RESULT.length-1:0>s?0:s,this.selectIndex!==s&&(this.selectIndex=s,this.$result_list.find(".search-result-item._selected").removeClass("_selected"),this.$result_list.find(".search-result-item").eq(s).addClass("_selected"))}},this.init=function(){var e="",s={38:"ArrowUp",40:"ArrowDown",9:"Tab",13:"Enter",27:"Escape"},i=function(s){t.checkLength()?s!==e&&t.updateResult(s):(t.timeoutId&&clearTimeout(t.timeoutId),t.clearResult()),e=s,t.updateFormClass()};this.$input.on("keydown",function(e){var i=s[e.keyCode];if("ArrowUp"==i||"ArrowDown"==i){e.preventDefault();var a="ArrowUp"==i?-1:"ArrowDown"==i?1:0;t.selectResultItem(a)}}).on("keyup",function(e){return s[e.keyCode]?void e.preventDefault():void i($(this).val())}).on("focusin click",function(){$("html").addClass("open-search")}),i(this.$input.val()),this.$input.is(":focus")&&$("html").addClass("open-search"),this.$form.on("click",".js-search-cancel",function(e){e.preventDefault(),t.clear(),t.toggleDescriptionText(),t.updateFormClass(),$("html").removeClass("open-search"),t.$input.blur()}),this.$overlay.on("click",function(){$("html").removeClass("open-search")}),$(document).on("keyup",function(e){"Escape"==s[e.keyCode]&&$("html").hasClass("open-search")&&($("html").removeClass("open-search"),t.$input.blur())}),this.$result_list.on("touchstart",function(){t.$input.blur()}).on("mouseover",".search-result-item",function(){t.selectResultItem($(this).index(),!0)}),t.$form.on("submit",function(e){e.preventDefault(),t.RESULT&&t.RESULT[t.selectIndex]&&(document.location.href=t.RESULT[t.selectIndex].URL)})},this.init()};